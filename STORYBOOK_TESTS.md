# Storybook Tests Documentation

## Обзор

Этот документ описывает автоматизированные тесты, добавленные в Storybook stories для компонентов чата и UI. Тесты используют `@storybook/test` для проверки корректности рендеринга, анимаций и интерактивности компонентов.

## Структура тестов

### Основные инструменты

- **`@storybook/test`** - основной пакет для тестирования
- **`within`** - для поиска элементов внутри canvas
- **`expect`** - для assertions
- **`userEvent`** - для симуляции пользовательских действий

### Общие паттерны тестирования

```typescript
play: async ({ canvasElement }) => {
  const canvas = within(canvasElement);
  
  // Ждем появления компонента
  await new Promise(resolve => setTimeout(resolve, 100));
  
  // Проверяем, что компонент отрендерился
  expect(canvasElement).toBeInTheDocument();
  
  // Дополнительные проверки...
}
```

## Компоненты с тестами

### ChatHorizontal

**Файл:** `src/components/ChatHorizontal/ChatHorizontal.stories.tsx`

**Тесты:**
- `Default` - базовая проверка рендеринга
- `WithMockData` - проверка пустого состояния
- `WithSimulatedMessages` - проверка с автоматически генерируемыми сообщениями
- `WithFastMessages` - проверка быстрых сообщений

**Особенности:**
- Создание начальных сообщений сразу при монтировании
- Улучшенная обработка асинхронности с дополнительными проверками
- Уменьшенные интервалы для более быстрого тестирования

### ChatHorizontal Message

**Файл:** `src/components/ChatHorizontal/Message.stories.tsx`

**Тесты:**
- `Default` - базовое сообщение
- `VIPUser` - VIP пользователь с градиентным фоном
- `Moderator` - модератор с соответствующими стилями
- `Broadcaster` - стример с особым оформлением
- `MultipleMessages` - множественные сообщения

**Проверки:**
- Структура сообщения (никнейм, текст)
- Цвета и стили для разных ролей
- Анимация движения по экрану
- Градиентные фоны для VIP/модераторов/стримеров

### ChatVertical

**Файл:** `src/components/ChatVertical/ChatVertical.stories.tsx`

**Тесты:**
- `Default` - базовая проверка вертикального чата
- `Empty` - пустое состояние
- `WithSimulatedMessages` - симуляция сообщений
- `WithFastMessages` - быстрые сообщения

**Особенности:**
- Проверка вертикального расположения (`flexDirection: column-reverse`)
- Структура сообщений (левая и правая части)
- Анимация появления сообщений

### ChatVertical Message

**Файл:** `src/components/ChatVertical/Message.stories.tsx`

**Тесты:**
- `Default` - базовое вертикальное сообщение
- `VIPUser` - VIP с розовой ролью
- `Moderator` - модератор с зеленой ролью
- `Broadcaster` - стример с красной ролью
- `MultipleMessages` - множественные сообщения

**Проверки:**
- Роли пользователей с соответствующими цветами
- Структура сообщения (контейнер, левая/правая части)
- Градиентный текст для особых ролей

### PyroAlerts

**Файл:** `src/components/PyroAlerts/PyroAlerts.stories.tsx`

**Тесты:**
- `Default` - базовая система алертов
- `Empty` - пустое состояние

**Проверки:**
- Отсутствие активных алертов в начальном состоянии
- Структура системы алертов

### WaifuAlerts

**Файл:** `src/components/WaifuAlerts/WaifuAlerts.stories.tsx`

**Тесты:**
- `Default` - базовая система вайфу-алертов
- `Empty` - пустое состояние

**Проверки:**
- Отсутствие активных вайфу-событий
- Отсутствие рулетки и конфетти

### ScreenParticles Manager

**Файл:** `src/components/ScreenParticles/Manager.stories.tsx`

**Тесты:**
- `Default` - базовый менеджер частиц
- `Empty` - пустое состояние

**Проверки:**
- Отсутствие активных частиц
- Отсутствие canvas элементов

### FumoFriday

**Файл:** `src/components/FumoFriday/FumoFriday.stories.tsx`

**Тесты:**
- `Default` - базовый компонент Fumo Friday
- `Empty` - пустое состояние

**Проверки:**
- Отсутствие активных Fumo Friday событий
- Отсутствие видео и текста поздравлений

### HighliteMessage

**Файл:** `src/components/HighliteMessage/HighliteMessage.stories.tsx`

**Тесты:**
- `Default` - базовая система всплывающих сообщений
- `Empty` - пустое состояние

**Проверки:**
- Отсутствие активных всплывающих сообщений
- Отсутствие изображений и видео

### CurrentTrack

**Файл:** `src/components/SoundRequest/CurrentTrack/CurrentTrack.stories.tsx`

**Тесты:**
- `Default` - базовый трек с обложкой
- `WithoutCover` - трек без обложки
- `WithAnimation` - трек с анимацией

**Проверки:**
- Отображение информации о треке
- Наличие/отсутствие обложки
- Анимация появления

### RainbowText

**Файл:** `src/shared/components/RainbowText/RainbowText.stories.tsx`

**Тесты:**
- `Default` - базовый радужный текст
- `CustomColors` - пользовательские цвета
- `LongText` - длинный текст

**Проверки:**
- Рендеринг текста
- Применение радужных стилей
- Анимация цветов

### GradientText

**Файл:** `src/shared/Utils/Animations/GradientText.stories.tsx`

**Тесты:**
- `Default` - базовый градиентный текст
- `CustomGradient` - пользовательский градиент
- `Animated` - анимированный градиент

**Проверки:**
- Применение градиентных стилей
- Анимация градиента
- Различные конфигурации

### KeyWordText

**Файл:** `src/shared/components/KeyWordText/KeyWordText.stories.tsx`

**Тесты:**
- `Default` - базовое выделение ключевых слов
- `CustomKeywords` - пользовательские ключевые слова
- `MultipleKeywords` - множественные ключевые слова

**Проверки:**
- Выделение ключевых слов
- Применение пользовательских стилей
- Корректная обработка множественных ключевых слов

## Улучшения надежности тестов

### Проблемы и решения

**Проблема:** Тесты падали из-за того, что сообщения не успевали появиться в течение ожидаемого времени.

**Решение:**
1. **Создание начальных сообщений сразу** - добавление сообщений при монтировании компонента
2. **Уменьшение интервалов** - сокращение времени между сообщениями
3. **Дополнительные проверки** - повторная проверка после дополнительного ожидания
4. **Улучшенная обработка асинхронности** - более надежные паттерны ожидания

### Пример улучшенного теста

```typescript
play: async ({ canvasElement }) => {
  // Ждем появления компонента
  await new Promise(resolve => setTimeout(resolve, 100));
  
  // Проверяем, что компонент отрендерился
  expect(canvasElement).toBeInTheDocument();
  
  // Ждем появления сообщений
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  // Проверяем, что сообщения появились
  const messages = canvasElement.querySelectorAll('[class*="message"]');
  
  // Если сообщения еще не появились, ждем еще немного
  if (messages.length === 0) {
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
  
  const updatedMessages = canvasElement.querySelectorAll('[class*="message"]');
  expect(updatedMessages.length).toBeGreaterThan(0);
}
```

## Инструкции по расширению

### Добавление нового теста

1. **Создайте story с play функцией:**
```typescript
export const NewTest: Story = {
  args: { /* props */ },
  play: async ({ canvasElement }) => {
    // Тестовый код
  },
};
```

2. **Используйте стандартные паттерны:**
   - Ждите появления компонента
   - Проверяйте базовую структуру
   - Тестируйте специфичную функциональность
   - Добавьте дополнительные проверки при необходимости

3. **Для асинхронных компонентов:**
   - Создавайте начальные данные сразу
   - Используйте дополнительные проверки
   - Уменьшайте интервалы для быстрого тестирования

### Лучшие практики

1. **Всегда ждите появления компонента** перед проверками
2. **Используйте дополнительные проверки** для асинхронных элементов
3. **Тестируйте как позитивные, так и негативные сценарии**
4. **Проверяйте структуру DOM** и стили
5. **Добавляйте описания** для сложных тестов

### Отладка тестов

1. **Проверьте консоль браузера** на ошибки
2. **Увеличьте время ожидания** при необходимости
3. **Добавьте дополнительные проверки** для отладки
4. **Используйте `console.log`** для временной отладки

## Заключение

Эти тесты обеспечивают автоматизированную проверку корректности работы компонентов чата и UI. Они помогают выявлять регрессии и обеспечивают стабильность интерфейса при разработке.

При добавлении новых компонентов или изменении существующих, обязательно добавляйте соответствующие тесты, следуя описанным паттернам и лучшим практикам. 